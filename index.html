<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synthetix Stats</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        #embed-container {
            width: 100%;
            height: 100%;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>

<body>
    <div id="embed-container">
        <iframe id="statsFrame"></iframe>
    </div>
    <script>
        const BASE_PATH = '/data-tools';

        function initializeEmbed() {
            // Check for redirect path in session storage
            const storedPath = sessionStorage.getItem('redirectPath');
            let pathAfterBase = storedPath ? storedPath : window.location.pathname + window.location.search + window.location.hash;

            // Clear the stored path once retrieved
            sessionStorage.removeItem('redirectPath');

            if (pathAfterBase.startsWith(BASE_PATH)) {
                pathAfterBase = pathAfterBase.substring(BASE_PATH.length);
            }

            // If pathAfterBase is empty, set to "/"
            if (!pathAfterBase || pathAfterBase === '') {
                pathAfterBase = '/';
            }

            const [pathname, search] = pathAfterBase.split('?');
            const params = new URLSearchParams(search || '');
            params.set('embedded', 'true');

            let baseUrl = 'https://synthetix.streamlit.app';
            let appPath = pathname;

            if (pathname.startsWith('/all')) {
                baseUrl = 'https://synthetix-all.streamlit.app';
                appPath = pathname.substring(4);
                if (appPath === '') appPath = '/';
            }

            const finalUrl = `${baseUrl}${appPath}?${params.toString()}`;
            document.getElementById('statsFrame').src = finalUrl;

            // Attempt to update the displayed URL without reloading the page
            try {
                const displayPath = BASE_PATH + pathAfterBase;
                window.history.replaceState({}, '', displayPath);
            } catch (e) {
                console.warn('Could not update URL:', e);
            }
        }

        window.addEventListener('load', initializeEmbed);
        window.addEventListener('popstate', initializeEmbed);
    </script>
</body>

</html>